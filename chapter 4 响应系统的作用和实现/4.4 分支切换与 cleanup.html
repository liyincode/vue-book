<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>4.4 分支切换与 cleanup</title>
</head>
<body>
</body>

<script>
  /*
   1. 产生了没必要的副作用函数的触发
   */
  const data = { ok: true, text: 'hello world' };

  const bucket = new WeakMap();

  let activeEffect;

  function effect(fn) {
    activeEffect = fn;
    fn();
  }

  const obj = new Proxy(data, {
    get(target, key) {
      if (!activeEffect) return target[key];

      track(target, key);

      return target[key];
    },

    set(target, key, newValue) {
      target[key] = newValue;

      trigger(target, key)

      return true;
    }
  })

  function track(target, key) {
    console.log('track', target, key)
    let depsMap = bucket.get(target);
    if (!depsMap) {
      bucket.set(target, (depsMap = new Map()));
    }

    let deps = depsMap.get(key);
    if (!deps) {
      depsMap.set(key, (deps = new Set()));
    }

    deps.add(activeEffect);
  }

  function trigger(target, key) {
    console.log('trigger ', target, key)
    const depsMap = bucket.get(target);
    if (!depsMap) return;
    const effects = depsMap.get(key);

    effects && effects.forEach(fn => fn());
  }

  effect(
          function effectFn() {
            console.log('副作用函数触发')
            document.body.innerHTML = obj.ok ? obj.text : 'not';
          }
  )

  // 当 obj.ok = false，不管 obj.text 如何更改，都不应该触发副作用函数，因为副作用函数中的三元表达式已经说明了和 text 属性无关了
  // 但这里 text 更改后有一次触发了副作用函数
  obj.ok = false;
  obj.text = 'hello vue3'
</script>

</html>
